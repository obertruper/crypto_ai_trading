#!/bin/bash
# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Vast.ai —Å–µ—Ä–≤–µ—Ä—É —Å –ø—Ä–æ–±—Ä–æ—Å–æ–º –ø–æ—Ä—Ç–æ–≤

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}üöÄ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Vast.ai GPU —Å–µ—Ä–≤–µ—Ä—É${NC}"

# –í—ã–±–æ—Ä —Å–ø–æ—Å–æ–±–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
if [ -n "$VAST_CONNECTION_MODE" ]; then
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è
    choice=$VAST_CONNECTION_MODE
else
    # –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –≤—ã–±–æ—Ä
    echo -e "\n${YELLOW}–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:${NC}"
    echo "1) –ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ (114.32.64.6:40134)"
    echo "2) –ß–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏ (ssh3.vast.ai:33915)"
    echo -n "–í—ã–±–æ—Ä (1/2): "
    read choice
fi

if [ "$choice" = "1" ]; then
    HOST="114.32.64.6"
    PORT="40134"
else
    HOST="ssh3.vast.ai"
    PORT="33915"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ SSH –∫–ª—é—á–∞
KEY_PATH="$HOME/.ssh/vast_ai_key"
if [ ! -f "$KEY_PATH" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  SSH –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ $KEY_PATH${NC}"
    echo "–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á:"
    echo "nano $KEY_PATH"
    echo "chmod 600 $KEY_PATH"
    exit 1
fi

# SSH –∫–æ–º–∞–Ω–¥–∞ —Å –ø—Ä–æ–±—Ä–æ—Å–æ–º –ø–æ—Ä—Ç–æ–≤
SSH_CMD="ssh -p $PORT root@$HOST"
SSH_CMD="$SSH_CMD -i $KEY_PATH"
SSH_CMD="$SSH_CMD -L 8080:localhost:8080"  # Web UI
SSH_CMD="$SSH_CMD -L 6006:localhost:6006"  # TensorBoard
SSH_CMD="$SSH_CMD -L 8888:localhost:8888"  # Jupyter

echo -e "${GREEN}üì° –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ $HOST:$PORT${NC}"
echo -e "${GREEN}üåê –ü—Ä–æ–±—Ä–æ—à–µ–Ω–Ω—ã–µ –ø–æ—Ä—Ç—ã:${NC}"
echo "   ‚Ä¢ Web UI:     http://localhost:8080"
echo "   ‚Ä¢ TensorBoard: http://localhost:6006"
echo "   ‚Ä¢ Jupyter:     http://localhost:8888"
echo ""

# –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
echo -e "${YELLOW}–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:${NC}"
echo "1) –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è SSH —Å–µ—Å—Å–∏—è —Å –ø—Ä–æ–±—Ä–æ—Å–æ–º –ø–æ—Ä—Ç–æ–≤"
echo "2) –¢–æ–ª—å–∫–æ –ø—Ä–æ–±—Ä–æ—Å –ø–æ—Ä—Ç–æ–≤ (—Ñ–æ–Ω–æ–≤—ã–π —Ä–µ–∂–∏–º)"
echo -n "–í—ã–±–æ—Ä (1/2): "
read mode

if [ "$mode" = "2" ]; then
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç—É–Ω–Ω–µ–ª–∏ –≤ —Ñ–æ–Ω–µ
    echo -e "${YELLOW}–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç—É–Ω–Ω–µ–ª–∏ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ...${NC}"
    # –ó–∞–ø—É—Å–∫–∞–µ–º SSH –∫–æ–º–∞–Ω–¥—É –≤ —Ñ–æ–Ω–µ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
    $SSH_CMD -f -N
    echo -e "${GREEN}‚úÖ –¢—É–Ω–Ω–µ–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã!${NC}"
    echo ""
    echo "–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:"
    echo "  ‚Ä¢ TensorBoard: http://localhost:6006"
    echo "  ‚Ä¢ Web UI: http://localhost:8080"
    echo "  ‚Ä¢ Jupyter: http://localhost:8888"
    echo ""
    echo -e "${YELLOW}–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ç—É–Ω–Ω–µ–ª–µ–π –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:${NC}"
    echo "  pkill -f 'ssh.*-L.*6006'"
else
    # –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
    echo -e "${GREEN}–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...${NC}"
    echo -e "${YELLOW}–î–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: exit${NC}"
    echo ""
    exec $SSH_CMD
fi