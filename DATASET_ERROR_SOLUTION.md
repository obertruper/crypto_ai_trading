# üîß –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –æ—à–∏–±–∫–æ–π –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–∞—Ç–∞—Å–µ—Ç–∞

## üìã –ò—Å—Ö–æ–¥–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–æ—Å–∏–ª: "–ø—Ä–æ–≤–µ—Ä—å –≥–¥–µ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–∞—Ç–∞ —Å–µ—Ç–∞"

## üîç –ù–∞–π–¥–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞

### –°–∏–º–ø—Ç–æ–º—ã:
1. –≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ close_vwap_ratio –¥–æ **9.5e15**
2. Warnings –ø—Ä–∏ –æ–±—É—á–µ–Ω–∏–∏: "–û—á–µ–Ω—å –±–æ–ª—å—à–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤–æ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö"
3. –ù–∏–∑–∫–∞—è —É—Ç–∏–ª–∏–∑–∞—Ü–∏—è GPU (14-23%)
4. –ù–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è

### –ü—Ä–∏—á–∏–Ω–∞:
–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç VWAP (Volume Weighted Average Price) –≤ `feature_engineering.py`:
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–π `min_denominator = 1e-4`
- –ü—Ä–∏ –º–∞–ª—ã—Ö –æ–±—ä–µ–º–∞—Ö VWAP –ø–æ–ª—É—á–∞–ª—Å—è –±–ª–∏–∑–∫–∏–º –∫ –Ω—É–ª—é
- –î–µ–ª–µ–Ω–∏–µ `close / vwap` –¥–∞–≤–∞–ª–æ –æ–≥—Ä–æ–º–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è

## ‚úÖ –í–Ω–µ—Å–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –í –º–µ—Ç–æ–¥–µ `safe_divide`:
```python
# –ë—ã–ª–æ:
min_denominator = 1e-4  

# –°—Ç–∞–ª–æ:
min_denominator = 0.01  # –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
```

### 2. –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ `calculate_vwap`:
```python
def calculate_vwap(self, df: pd.DataFrame) -> pd.Series:
    """–£–ª—É—á—à–µ–Ω–Ω—ã–π —Ä–∞—Å—á–µ—Ç VWAP —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏"""
    vwap = self.safe_divide(df['turnover'], df['volume'], fill_value=df['close'])
    
    # VWAP –Ω–µ –¥–æ–ª–∂–µ–Ω –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç close –±–æ–ª–µ–µ —á–µ–º –≤ 2 —Ä–∞–∑–∞
    mask_invalid = (vwap < df['close'] * 0.5) | (vwap > df['close'] * 2.0)
    vwap[mask_invalid] = df['close'][mask_invalid]
    
    return vwap
```

### 3. –û–±–Ω–æ–≤–ª–µ–Ω —Ä–∞—Å—á–µ—Ç –≤ `_create_basic_features`:
```python
# VWAP —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º —Ä–∞—Å—á–µ—Ç–æ–º
df['vwap'] = self.calculate_vwap(df)
df['close_vwap_ratio'] = self.safe_divide(
    df['close'], 
    df['vwap'], 
    fill_value=1.0,
    max_value=2.0  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º ratio –º–∞–∫—Å–∏–º—É–º 2x
)
```

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- close_vwap_ratio: –æ—Ç -198.59 –¥–æ 9,564,650,651,581,954
- 2,181 –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –≤ train_data

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- close_vwap_ratio: —Å—Ç–∞–±–∏–ª—å–Ω–æ –æ–∫–æ–ª–æ 1.0 (–º–∞–∫—Å 2.0)
- 0 –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π

## üöÄ –ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ

1. **–ö—ç—à —É–∂–µ —É–¥–∞–ª–µ–Ω** ‚úÖ
   
2. **–ó–∞–ø—É—Å—Ç–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ —Å –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏**:
   ```bash
   python main.py --mode train
   ```
   
   –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –∫—ç—à —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏.

## üí° –û–∂–∏–¥–∞–µ–º—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–°—Ç–∞–±–∏–ª—å–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ** - –±–µ–∑ inf/NaN –≤ loss
2. **–õ—É—á—à–µ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ GPU** - –±–µ–∑ overhead –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏
3. **–ö–∞—á–µ—Å—Ç–≤–æ –º–æ–¥–µ–ª–∏** - —á–∏—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ –±–µ–∑ —à—É–º–∞
4. **–°–∫–æ—Ä–æ—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è** - —É–≤–µ–ª–∏—á–∏—Ç—Å—è –±–ª–∞–≥–æ–¥–∞—Ä—è –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—é –ø—Ä–æ–≤–µ—Ä–æ–∫

## üìù –í–∞–∂–Ω—ã–µ —Ñ–∞–π–ª—ã

- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω**: `data/feature_engineering.py`
- **–°–æ–∑–¥–∞–Ω**: `test_vwap_fix.py` - –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- **–°–æ–∑–¥–∞–Ω**: `fix_vwap_calculation.py` - –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã
- **–£–¥–∞–ª–µ–Ω—ã**: —Å—Ç–∞—Ä—ã–µ –∫—ç—à-—Ñ–∞–π–ª—ã –≤ `data/processed/`

---

*–†–µ—à–µ–Ω–∏–µ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ: 2025-07-01 21:48*