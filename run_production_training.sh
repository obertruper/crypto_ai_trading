#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ production –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–∏ —Å –Ω–æ–≤—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏

echo "üöÄ –ó–∞–ø—É—Å–∫ PRODUCTION –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–∏ –¥–ª—è —Ç—Ä–µ–π–¥–∏–Ω–≥–∞"
echo "=================================================="

# –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
if [ -d "venv" ]; then
    source venv/bin/activate
    echo "‚úÖ –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ GPU
echo ""
echo "üñ•Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ GPU..."
nvidia-smi --query-gpu=name,memory.total --format=csv,noheader || echo "‚ö†Ô∏è GPU –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω"

echo ""
echo "üìä –ù–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è:"
echo "- –ü–æ—Ä–æ–≥–∏ FLAT —É–º–µ–Ω—å—à–µ–Ω—ã –≤ 2.5 —Ä–∞–∑–∞ (0.1%-1%)"
echo "- –í–µ—Å–∞ –∫–ª–∞—Å—Å–æ–≤: LONG=2.5, SHORT=2.5, FLAT=0.3"
echo "- Direction loss weight: 25.0"
echo "- Focal loss gamma: 5.0"
echo "- WeightedRandomSampler –≤–∫–ª—é—á–µ–Ω"
echo ""

# –ó–∞–ø—É—Å–∫ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö
echo "üì• –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å –Ω–æ–≤—ã–º–∏ –ø–æ—Ä–æ–≥–∞–º–∏..."
python main.py --mode data --prepare-data

if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö"
    exit 1
fi

echo ""
echo "‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã"
echo ""

# –ó–∞–ø—É—Å–∫ –æ–±—É—á–µ–Ω–∏—è —Å production –∫–æ–Ω—Ñ–∏–≥–æ–º
echo "üéØ –≠—Ç–∞–ø 2: –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ —Å production –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π..."
python main.py --mode production

if [ $? -ne 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—É—á–µ–Ω–∏–∏ –º–æ–¥–µ–ª–∏"
    exit 1
fi

echo ""
echo "‚úÖ –û–±—É—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
if [ -f "models_saved/best_model.pth" ]; then
    echo "üìä –ú–æ–¥–µ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤: models_saved/best_model.pth"
    ls -lh models_saved/best_model.pth
else
    echo "‚ö†Ô∏è –ú–æ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
fi

echo ""
echo "üìà –õ–æ–≥–∏ –æ–±—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã –≤: logs/"
ls -lt logs/ | head -5

echo ""
echo "üéâ Production –æ–±—É—á–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""
echo "–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –æ–±—É—á–µ–Ω–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –º–µ—Ç—Ä–∏–∫"
echo "2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ: python evaluate_model_production.py"
echo "3. –î–ª—è –±—ç–∫—Ç–µ—Å—Ç–∞: python main.py --mode backtest --model-path models_saved/best_model.pth"