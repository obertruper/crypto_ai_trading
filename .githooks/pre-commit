#!/bin/bash

# Pre-commit hook Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð¹ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ð¿ÐµÑ€ÐµÐ´ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¾Ð¼
# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚ Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ñ‹Ð¼ Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸ÐµÐ¼

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ñ GitHub..."

# ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
git fetch origin main --quiet

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ Ñ€Ð°ÑÑ…Ð¾Ð¶Ð´ÐµÐ½Ð¸Ñ
LOCAL=$(git rev-parse HEAD)
REMOTE=$(git rev-parse origin/main)

if [ "$LOCAL" != "$REMOTE" ]; then
    echo -e "${YELLOW}âš ï¸  Ð’Ð°ÑˆÐ° Ð²ÐµÑ‚ÐºÐ° Ñ€Ð°ÑÑ…Ð¾Ð´Ð¸Ñ‚ÑÑ Ñ origin/main${NC}"
    echo -e "${YELLOW}Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ ÑÐ½Ð°Ñ‡Ð°Ð»Ð° ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒÑÑ:${NC}"
    echo -e "${GREEN}./scripts/git_sync.sh${NC}"
    echo ""
    read -p "ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚ Ð±ÐµÐ· ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ð¸? (y/N): " choice
    case "$choice" in 
        y|Y ) 
            echo -e "${YELLOW}ÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð°ÐµÐ¼ Ð±ÐµÐ· ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ð¸...${NC}"
            ;;
        * )
            echo -e "${RED}ÐšÐ¾Ð¼Ð¼Ð¸Ñ‚ Ð¾Ñ‚Ð¼ÐµÐ½ÐµÐ½. Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð¸Ñ€ÑƒÐ¹Ñ‚ÐµÑÑŒ.${NC}"
            exit 1
            ;;
    esac
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ€Ð°Ð·Ð¼ÐµÑ€ Ñ„Ð°Ð¹Ð»Ð¾Ð²
LARGE_FILES=$(find . -type f -size +50M -not -path "./.git/*" -not -path "./data/processed/*" -not -path "./venv_crypto/*" -not -path "./models_saved/*" -not -path "./cache/*" -not -path "./*.sql" 2>/dev/null)

if [ ! -z "$LARGE_FILES" ]; then
    echo -e "${RED}âŒ ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ñ‹ Ð±Ð¾Ð»ÑŒÑˆÐ¸Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ (>50MB):${NC}"
    echo "$LARGE_FILES"
    echo -e "${YELLOW}Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð¸Ñ… Ð² .gitignore${NC}"
    exit 1
fi

echo -e "${GREEN}âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ð°${NC}"